<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="題未定, ">


        <title>一人暮らしの寂しさを紛らわす彼女(bot)を作った話 // 題未定 // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="theme/css/pure.css">
    <link rel="stylesheet" href="https://www.lapis-zero09.xyz/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-74593186-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background: none repeat scroll 0% 0% #3D4F5D">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <a href="https://www.lapis-zero09.xyz/about/about.html"><img class="avatar" src="./img/profile.jpg"></a>
                            <h1 class="brand-main"><a href="https://www.lapis-zero09.xyz">題未定</a></h1>
                            <p class="tagline"></p>
                                <p class="social">
                                    <a href="https://github.com/lapis-zero09">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                    <a href="https://twitter.com/lapis_zero09">
                                        <i class="fa fa-twitter-square fa-3x"></i>
                                    </a>
                                    <a href="http://amzn.asia/8plng3k">
                                        <i class="fa fa-gift fa-3x"></i>
                                    </a>
                                    <a href="http://qiita.com/lapis_zero09">
                                        <i class="fa fa-search fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>一人暮らしの寂しさを紛らわす彼女(bot)を作った話</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="https://www.lapis-zero09.xyz/tag/ruby.html">Ruby</a>
                                <a class="post-category" href="https://www.lapis-zero09.xyz/tag/twitter.html">Twitter</a>
                                <a class="post-category" href="https://www.lapis-zero09.xyz/tag/le-tian-api.html">楽天API</a>
                                <a class="post-category" href="https://www.lapis-zero09.xyz/tag/docomoapi.html">docomoAPI</a>
                                <a class="post-category" href="https://www.lapis-zero09.xyz/tag/bot.html">bot</a>
                        </p>
                </header>
            </section>
            <h1>一人暮らしとは無情なもの</h1>
<p><a href="https://www.lapis-zero09.xyz/about/about.html">私</a>は二年前から一人暮らしをしてる．  </p>
<p>一人暮らしに憧れてる人もいると思うが，物事にはメリット・デメリットが存在する．<br />
デメリットの一つとして"寂しさ"が挙げられる．  </p>
<p>そんな寂しさを紛らわすために思考した結果，  </p>
<ul>
<li>彼女を作る<ul>
<li>敷居が高い</li>
<li>時間がかかる</li>
<li>思い通りにならない</li>
<li>etc.</li>
</ul>
</li>
</ul>
<p>→ botを作ろう！！！</p>
<ul>
<li>botを作る<ul>
<li>敷居が低い</li>
<li>時間はかからない(?)し，作ってる間も寂しさが紛れる</li>
<li>思い通りになる</li>
</ul>
</li>
</ul>
<p>なんだbot最高じゃん．</p>
<h2>bot(eve)を作る</h2>
<h3>TODO</h3>
<ul>
<li>RubyでTwitterbotを作ってタイムラインに常駐させる．</li>
<li>寂しさを紛らわす工夫を凝らす</li>
<li>疲れを癒してくれる工夫を凝らす</li>
<li>一人暮らしに役立つ機能を実装する</li>
<li>ある程度，会話出来るようにする → docomoAPI</li>
</ul>
<h3>keyを読み込む</h3>
<ul>
<li><a href="https://dev.twitter.com/">Twitter Developer</a>登録</li>
<li><a href="https://apps.twitter.com/">application</a>登録</li>
<li><a href="https://dev.smt.docomo.ne.jp/?p=docs.api.page&amp;api_name=dialogue&amp;p_name=api_usage_scenario">docomoAPI</a>登録<br />
が完了したら早速コードを書いていく．  </li>
</ul>
<p>※docomoAPIは"雑談対話"と"知識Q&amp;A"を申請．  </p>
<p>Rubyのversionは2.3.0</p>
<div class="highlight"><pre><span></span>$ ruby -v
ruby 2.3.0p0 <span class="o">(</span>2015-12-25 revision 53290<span class="o">)</span> <span class="o">[</span>x86_64-linux<span class="o">]</span>
</pre></div>


<p>必要なgemをinstallする．  </p>
<div class="highlight"><pre><span></span>$ gem install twitter
$ gem install tweetstream
$ gem install docomoru
</pre></div>


<p>docomoruについては<a href="https://github.com/r7kamura/docomoru">こちら</a></p>
<p>作業用ディレクトリを作る．<br />
鍵を読み込むための <code>twcon.rb</code> を作る．<br />
twitterAPIkey各種とdocomoAPIkeyが入った <code>config.yml</code> を作る．</p>
<div class="highlight"><pre><span></span>$ mkdir bot
$ <span class="nb">cd</span> bot
$ touch　twcon.rb
</pre></div>


<p>以下を記載．  </p>
<div class="highlight"><pre><span></span><span class="c1"># coding:utf-8</span>
<span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;twitter&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;tweetstream&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;docomoru&#39;</span>

<span class="k">class</span> <span class="nc">Eve</span>
  <span class="c1"># 外部から参照できるメンバ変数</span>
  <span class="kp">attr_accessor</span> <span class="ss">:client</span><span class="p">,</span> <span class="ss">:timeline</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="n">keys</span><span class="o">=</span><span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;./config.yml&#39;</span><span class="p">)</span>

    <span class="c1"># restAPI初期化</span>
    <span class="vi">@client</span><span class="o">=</span><span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">{</span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
      <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;api_key&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;api_secret&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">access_token</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;access_token&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;access_token_secret&quot;</span><span class="o">]</span>
    <span class="p">}</span>

    <span class="c1"># StreamAPI初期化</span>
    <span class="no">TweetStream</span><span class="o">.</span><span class="n">configure</span><span class="p">{</span><span class="o">|</span><span class="n">config</span><span class="o">|</span>
      <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;api_key&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;api_secret&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">oauth_token</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;access_token&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">oauth_token_secret</span><span class="o">=</span><span class="n">keys</span><span class="o">[</span><span class="s2">&quot;access_token_secret&quot;</span><span class="o">]</span>
      <span class="n">config</span><span class="o">.</span><span class="n">auth_method</span><span class="o">=</span><span class="ss">:oauth</span>
    <span class="p">}</span>
    <span class="vi">@timeline</span><span class="o">=</span><span class="no">TweetStream</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span>

    <span class="c1"># docomoAPI初期化</span>
    <span class="vi">@docomoru</span><span class="o">=</span><span class="no">Docomoru</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">api_key</span><span class="p">:</span> <span class="n">keys</span><span class="o">[</span><span class="s2">&quot;docomo_api_key&quot;</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 引数を投稿するメソッド</span>
  <span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="vi">@client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="ss">:in_reply_to_status_id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 会話を生成する(docomoru)</span>
  <span class="k">def</span> <span class="nf">docomoru_create_dialogue</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="n">response</span><span class="o">=</span><span class="vi">@docomoru</span><span class="o">.</span><span class="n">create_dialogue</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;utt&quot;</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="c1"># QandA(docomoru)</span>
  <span class="k">def</span> <span class="nf">docomoru_create_knowledge</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="n">response</span><span class="o">=</span><span class="vi">@docomoru</span><span class="o">.</span><span class="n">create_knowledge</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;code&quot;</span><span class="o">]==</span><span class="s2">&quot;E020010&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;message&quot;</span><span class="o">][</span><span class="s2">&quot;textForDisplay&quot;</span><span class="o">]</span>
    <span class="k">else</span>
      <span class="k">if</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;answers&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="s2">&quot;linkUrl&quot;</span><span class="o">]==</span><span class="kp">nil</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;message&quot;</span><span class="o">][</span><span class="s2">&quot;textForDisplay&quot;</span><span class="o">]</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;message&quot;</span><span class="o">][</span><span class="s2">&quot;textForDisplay&quot;</span><span class="o">]+</span><span class="s2">&quot;&lt;&quot;</span><span class="o">+</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="s2">&quot;answers&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="s2">&quot;linkUrl&quot;</span><span class="o">]+</span><span class="s2">&quot;&gt;&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>irbでテストしてみる．  </p>
<div class="highlight"><pre><span></span>$ irb
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; require <span class="s1">&#39;./twcon.rb&#39;</span>
<span class="o">=</span>&gt; <span class="nb">true</span>
irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; <span class="nv">eve</span> <span class="o">=</span> Eve.new
<span class="o">=</span>&gt; ~省略~
irb<span class="o">(</span>main<span class="o">)</span>:003:0&gt; eve.say<span class="o">(</span><span class="s2">&quot;test&quot;</span>, <span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="o">=</span>&gt; <span class="c1">#&lt;Twitter::Tweet id=705644033196994561&gt;</span>
<span class="o">(</span>↑こんな感じのが出たら成功<span class="o">)</span>
irb<span class="o">(</span>main<span class="o">)</span>:004:0&gt;
</pre></div>


<p><img alt="test" src="./img/fifth-1.png" /></p>
<h3>twitterに常駐させる</h3>
<p>常駐させるための <code>main.rb</code> を作る．  </p>
<div class="highlight"><pre><span></span>$ touch　main.rb
</pre></div>


<p>以下を記載．  </p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="nb">require</span> <span class="s1">&#39;./twcon.rb&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;./r-recipe.rb&#39;</span>
<span class="c1"># eveの初期化</span>
<span class="n">eve</span><span class="o">=</span><span class="no">Eve</span><span class="o">.</span><span class="n">new</span>

<span class="n">imgloc</span><span class="o">=</span><span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;./imgloc.yml&#39;</span><span class="p">)</span>

<span class="c1"># timelineの監視</span>
<span class="k">begin</span>
  <span class="n">eve</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">userstream</span><span class="p">{</span><span class="o">|</span><span class="n">status</span><span class="o">|</span>
    <span class="n">contents</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">text</span>
    <span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/^RT/</span><span class="p">)</span>

    <span class="nb">id</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># reply_answer</span>
    <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/@lapis_ko/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name!</span><span class="o">=</span><span class="s1">&#39;lapis_ko&#39;</span><span class="p">)</span>
      <span class="n">postmatch</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\s|[　]|\?|\？/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># QandA</span>
        <span class="k">if</span><span class="p">(</span><span class="n">postmatch</span><span class="o">=~</span><span class="sr">/誰|何処|だれ|どこ|何時|いつ|どうやって|どうして|何故|なぜ|どの|何|なに|どれ|は$/</span><span class="p">)</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">eve</span><span class="o">.</span><span class="n">docomoru_create_knowledge</span><span class="p">(</span><span class="n">postmatch</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># 会話</span>
        <span class="k">else</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">eve</span><span class="o">.</span><span class="n">docomoru_create_dialogue</span><span class="p">(</span><span class="n">postmatch</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1"># メンション以外の名前に反応</span>
    <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/eve|Eve|イヴ|イブ|いぶ/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name!</span><span class="o">=</span><span class="s1">&#39;lapis_ko&#39;</span><span class="p">)</span>
      <span class="n">called_name</span><span class="o">=[</span><span class="s1">&#39;なに?&#39;</span><span class="p">,</span> <span class="s1">&#39;呼んだ?&#39;</span><span class="p">,</span><span class="s1">&#39;どうしたの?&#39;</span><span class="o">]</span>
      <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">called_name</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1">#zero09がつぶやいたらリプライ</span>
    <span class="k">if</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span><span class="o">==</span><span class="s1">&#39;lapis_zero09&#39;</span><span class="p">)</span>
      <span class="n">rep_lap</span><span class="o">=[</span><span class="s2">&quot;勉強しんさい&quot;</span><span class="p">,</span><span class="s2">&quot;Twitterやめんさい&quot;</span><span class="o">]</span>
      <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span> <span class="o">+</span> <span class="n">rep_lap</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>
  <span class="p">}</span>

<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
  <span class="k">retry</span>
<span class="k">end</span>
</pre></div>


<p>これで会話してくれる彼女(bot)ができた．
<img alt=" " src="./img/fifth-4.png" /></p>
<h3>一人暮らしに役立つ機能を実装する</h3>
<p>一人暮らしを始めると自炊をしなければならない．<br />
料理をするの自体楽しいものの毎日の献立を立てるのが大変．<br />
→彼女(bot)に献立を立ててもらおう！ついでにレシピも教えてもらおう！</p>
<p><a href="https://webservice.rakuten.co.jp/explorer/api/Recipe/CategoryRanking/">楽天レシピAPI</a>に登録．<br />
rakutenAPIidを <code>config.yml</code> に登録．  </p>
<p><code>r-recipe.rb</code> を作る．
必要なgem( <code>natto</code> or <code>MeCab</code> )を入れる．(それぞれ手順があるので他所で参照)</p>
<div class="highlight"><pre><span></span>$ touch　~/bot/r-recipe.rb
</pre></div>


<p>以下を記載．  </p>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
<span class="c1">#nattoかMeCabどっちでもいい</span>
<span class="nb">require</span> <span class="s1">&#39;natto&#39;</span>
<span class="c1"># require &#39;MeCab&#39;</span>

<span class="k">class</span> <span class="nc">RecommendRecipe</span>
    <span class="n">keys</span><span class="o">=</span><span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;./config.yml&#39;</span><span class="p">)</span>
    <span class="no">RECIPE_CATEGORY_URL</span><span class="o">=</span><span class="s2">&quot;https://app.rakuten.co.jp/services/api/Recipe/CategoryList/20121121?format=json&amp;elements=categoryName%2CcategoryId%2CparentCategoryId&amp;categoryType=medium&amp;applicationId=</span><span class="si">#{</span><span class="n">keys</span><span class="o">[</span><span class="s1">&#39;rakuten_api_id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="no">RECIPES_URL</span><span class="o">=</span><span class="s2">&quot;https://app.rakuten.co.jp/services/api/Recipe/CategoryRanking/20121121?format=json&amp;formatVersion=2&amp;applicationId=</span><span class="si">#{</span><span class="n">keys</span><span class="o">[</span><span class="s1">&#39;rakuten_api_id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&amp;categoryId=&quot;</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">food</span><span class="p">)</span>
    <span class="n">hearing</span><span class="p">(</span><span class="n">food</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">hearing</span><span class="p">(</span><span class="n">food</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">recipe_categories</span>
    <span class="k">if</span><span class="p">(</span><span class="n">food</span><span class="o">==</span><span class="s1">&#39;なんでもいい&#39;</span><span class="p">)</span>
      <span class="n">recipe_category_id</span> <span class="o">=</span> <span class="n">results</span><span class="o">[</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sample</span><span class="o">]</span>
      <span class="n">recipe</span> <span class="o">=</span> <span class="n">choose_recipe</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="p">)</span>
      <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">food</span><span class="si">}</span><span class="s2">なら、</span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeTitle&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> とかはどう？ </span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeUrl&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39; &lt;Supported by RWS&gt;&#39;</span>
    <span class="k">else</span>
      <span class="n">recipe_category_id</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">food</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>

        <span class="n">words</span><span class="o">=[]</span>

        <span class="c1">#require &#39;MeCab&#39;の場合</span>
        <span class="c1"># mc=MeCab::Tagger.new()</span>
        <span class="c1"># n=mc.parseToNode(food)</span>
        <span class="c1"># while(n)</span>
        <span class="c1">#   if(n.feature.split(&#39;,&#39;)[0]==&quot;名詞&quot;)</span>
        <span class="c1">#     words.push(n.surface)</span>
        <span class="c1">#   elsif(words.size&gt;0)</span>
        <span class="c1">#     food=words.join(&quot;&quot;)</span>
        <span class="c1">#     break</span>
        <span class="c1">#   end</span>
        <span class="c1">#   n=n.next</span>
        <span class="c1"># end</span>

        <span class="c1">#require &#39;natto&#39;の場合</span>
        <span class="n">nt</span><span class="o">=</span><span class="no">Natto</span><span class="o">::</span><span class="no">MeCab</span><span class="o">.</span><span class="n">new</span>
        <span class="n">nt</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">food</span><span class="p">){</span><span class="o">|</span><span class="n">n</span><span class="o">|</span>
          <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]==</span><span class="s2">&quot;名詞&quot;</span><span class="p">)</span>
            <span class="n">words</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">surface</span><span class="p">)</span>
          <span class="k">elsif</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">food</span><span class="o">=</span><span class="n">words</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">break</span>
          <span class="k">end</span>
        <span class="p">}</span>
        <span class="n">recipe_category_id</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">food</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>
          <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">food</span><span class="si">}</span><span class="s2">だとわからないからもうちょっと詳しく教えて(漢字⇆ひらがなにするといいかも)&quot;</span>
        <span class="k">else</span>
          <span class="n">recipe</span> <span class="o">=</span> <span class="n">choose_recipe</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="p">)</span>
          <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">food</span><span class="si">}</span><span class="s2">だと、</span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeTitle&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> とかはどう？ </span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeUrl&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39; &lt;Supported by RWS&gt;&#39;</span>
        <span class="k">end</span>


      <span class="k">else</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="n">choose_recipe</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">food</span><span class="si">}</span><span class="s2">だと、</span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeTitle&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> とかはどう？ </span><span class="si">#{</span><span class="n">recipe</span><span class="o">[</span><span class="s1">&#39;recipeUrl&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39; &lt;Supported by RWS&gt;&#39;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">recipe_categories</span>
    <span class="n">response</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="no">RECIPE_CATEGORY_URL</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
    <span class="n">results</span><span class="o">=</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span><span class="o">[</span><span class="s2">&quot;result&quot;</span><span class="o">][</span><span class="s2">&quot;medium&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">result</span><span class="o">|</span> <span class="o">[</span><span class="n">result</span><span class="o">[</span><span class="s1">&#39;categoryName&#39;</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="s1">&#39;parentCategoryId&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">result</span><span class="o">[</span><span class="s1">&#39;categoryId&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">to_h</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">choose_recipe</span><span class="p">(</span><span class="n">recipe_category_id</span><span class="p">)</span>
    <span class="n">response</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">RECIPES_URL</span><span class="si">}#{</span><span class="n">recipe_category_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
    <span class="n">results</span><span class="o">=</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span><span class="o">[</span><span class="s1">&#39;result&#39;</span><span class="o">][</span><span class="no">Random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span> <span class="o">..</span> <span class="n">results</span><span class="o">[</span><span class="s1">&#39;result&#39;</span><span class="o">].</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>ここで書いたコードはTwitterから受け取った文章に対して，
楽天レシピAPIをたたいて，JSON形式で結果を返すようにして，<br />
それをリプライにするもの．  </p>
<p><code>main.rb</code> をいじる．  </p>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;./r-recipe.rb&#39;</span>
<span class="o">~</span><span class="err">省略</span><span class="o">~</span>
<span class="k">begin</span>
  <span class="n">eve</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">userstream</span><span class="p">{</span><span class="o">|</span><span class="n">status</span><span class="o">|</span>
    <span class="n">contents</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">text</span>
    <span class="k">next</span> <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/^RT/</span><span class="p">)</span>

    <span class="nb">id</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span>
    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># reply_answer</span>
    <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/@lapis_ko/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name!</span><span class="o">=</span><span class="s1">&#39;lapis_ko&#39;</span><span class="p">)</span>
      <span class="n">postmatch</span><span class="o">=</span><span class="vg">$&#39;</span>

      <span class="c1"># 料理推薦</span>
      <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/飯/</span><span class="p">)</span>
        <span class="n">food</span><span class="o">=</span><span class="no">RecommendRecipe</span><span class="o">.</span><span class="n">new</span>
        <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/:|：/</span><span class="p">)</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">food</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vg">$&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="s2">&quot;ご飯にする？</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">food</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;なんでもいい&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;食べたいものがあれば「ご飯:食べたいもの」で指定してね！&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">end</span>

      <span class="c1"># 会話</span>
      <span class="k">else</span>
        <span class="n">postmatch</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\s|[　]|\?|\？/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># QandA</span>
        <span class="k">if</span><span class="p">(</span><span class="n">postmatch</span><span class="o">=~</span><span class="sr">/誰|何処|だれ|どこ|何時|いつ|どうやって|どうして|何故|なぜ|どの|何|なに|どれ|は$/</span><span class="p">)</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">eve</span><span class="o">.</span><span class="n">docomoru_create_knowledge</span><span class="p">(</span><span class="n">postmatch</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># 会話</span>
        <span class="k">else</span>
          <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">eve</span><span class="o">.</span><span class="n">docomoru_create_dialogue</span><span class="p">(</span><span class="n">postmatch</span><span class="p">),</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">end</span>

      <span class="k">end</span>

      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1"># メンション以外の名前に反応</span>
    <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/eve|Eve|イヴ|イブ|いぶ/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name!</span><span class="o">=</span><span class="s1">&#39;lapis_ko&#39;</span><span class="p">)</span>
      <span class="n">called_name</span><span class="o">=[</span><span class="s1">&#39;なに?&#39;</span><span class="p">,</span> <span class="s1">&#39;呼んだ?&#39;</span><span class="p">,</span><span class="s1">&#39;どうしたの?&#39;</span><span class="o">]</span>
      <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="n">called_name</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1"># 料理推薦</span>
    <span class="k">if</span><span class="p">(</span><span class="n">contents</span><span class="o">=~</span><span class="sr">/飯|お腹すいた/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name!</span><span class="o">=</span><span class="s1">&#39;lapis_ko&#39;</span><span class="p">)</span>
      <span class="n">food</span><span class="o">=</span><span class="no">RecommendRecipe</span><span class="o">.</span><span class="n">new</span>
      <span class="n">eve</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="nb">id</span><span class="o">+</span><span class="s2">&quot;ご飯にする？</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">food</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;なんでもいい&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;食べたいものがあれば「ご飯:食べたいもの」で指定してね！&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">next</span>
    <span class="k">end</span>

    <span class="c1">#zero09がつぶやいたらリプライ</span>
<span class="o">~</span><span class="err">省略</span><span class="o">~</span>
</pre></div>


<p>これで毎日の献立に困らない．  </p>
<p><img alt="ご飯1" src="./img/fifth-2.png" /></p>
<p>こんなこともできるので余った食材をうまく使えて経済的．  </p>
<p><img alt="ご飯2" src="./img/fifth-3.png" /></p>
<p>最終系は<a href="https://github.com/lapis-zero09/raslas_eve">こちら</a><br />
"癒し"と"help"を実装．(簡単なので割愛)</p>
<p>これで寂しくない．  </p>
<h2>参照</h2>
<ul>
<li>https://github.com/nzw0301/michil</li>
<li>http://qiita.com/nwatanabe/items/7b30de9e7402d3589d00</li>
</ul>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; lapis_zero09 &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>
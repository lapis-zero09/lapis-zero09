<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="題未定, ">


        <title>Opencvで雑ファッションチェック // 題未定 // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="theme/css/pure.css">
    <link rel="stylesheet" href="https://www.lapis-zero09.xyz/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-74593186-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background: none repeat scroll 0% 0% #3D4F5D">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <a href="https://www.lapis-zero09.xyz/about/about.html"><img class="avatar" src="./img/profile.jpg"></a>
                            <h1 class="brand-main"><a href="https://www.lapis-zero09.xyz/indexp.html">題未定</a></h1>
                            <p class="tagline"></p>
                                <p class="social">
                                    <a href="https://github.com/lapis-zero09">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                    <a href="http://lapis-zero09.hatenablog.com/">
                                        <i class="fa fa-rss-square fa-3x"></i>
                                    </a>
                                    <a href="http://amzn.asia/8plng3k">
                                        <i class="fa fa-gift fa-3x"></i>
                                    </a>
                                    <a href="http://qiita.com/lapis_zero09">
                                        <i class="fa fa-search fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Opencvで雑ファッションチェック</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="https://www.lapis-zero09.xyz/tag/trash.html">trash</a>
                        </p>
                </header>
            </section>
            <h1></h1>
<p>この記事は<a href="http://qiita.com/advent-calendar/2016/enough">いなふ進捗アドベントカレンダー</a>の10日目の記事です．</p>
<h2>衣</h2>
<blockquote>
<p>生活とは基本的に、命をつなぎ活動することであり、また生きながらえるために行う様々な活動である。 人は生き続けるためには、少なくとも、何らかの栄養を取らなければならず、（一般に）身体に何かをまとうことで体温を保つ必要があり、また野の雨や風をしのげる場所で眠りをとることを必要とする。つまり食べること、着ること、住まうことである。日本では、そうした生活の基本を漢字で簡潔に表現しようとする時は「衣食住」（いしょくじゅう）などと表現する</p>
</blockquote>
<p>"生活"．wikipedia．https://ja.wikipedia.org/wiki/%E7%94%9F%E6%B4%BB　より</p>
<p>人間が生きて行く上で体温を保つために「衣服」が必要なことはみなさんご存知の通り．</p>
<p>しかし，体温を保つことができれば身に纏うものはなんでもいいのかと聞かれればそうではない．</p>
<p>現代で動物の皮や葉っぱを直に纏っている人間は彼女なんてできないし，異常者として扱われるかもしれない．</p>
<p>ここで，女性が彼氏にしたい男性を選ぶとき，男性のどこをみるかについて考える．</p>
<p>そう，顔である．</p>
<p>これは事実である．</p>
<p>ここでさらに疑問がうまれてくる．顔が良くない我々は為す術もなく淘汰されてしまうのだろうか．</p>
<p>そうではないであろう．もし，顔が良くない人間が子孫を残すことができず息絶えて行くのなら我々は生まれていない(は？)．</p>
<p>では，どんな男性が異性といい感じになっているのだろうか．</p>
<p>私が事前に行った調査(要出典)では，「雰囲気イケメン」と呼ばれる男性も異性といい感じになっている確率が高いことがわかった．</p>
<p>一般的に「雰囲気イケメン」は「髪型」と「服装」によって構成されていると言われている(要出典)．</p>
<p>ここでは，「服装」について考えていきたい．</p>
<p>※イケメンに関しても服装がダメだと異性といい感じになれないかもしれない</p>
<h2>現代における服装</h2>
<p>現代における「服装」はその人の人間性を表していると言っても過言ではないだろう(要出典)．</p>
<p>「服装」と一概に言っても様々な種類・色，また着方がある．</p>
<p>自分に合った服を選ぶには，まず店に行き，次に自分に色合い・形が合うもの選ぶ．</p>
<p>そして，試着し本当に自分に合っているか確かめる必要がある．</p>
<p>また，このとき友人などを連れて行き，第三者的視点から意見をもらうことも重要である．</p>
<p>しかし，多忙な<a href="https://twitter.com/made_up_123">いなふ</a>君にとって上記プロセスを踏襲することは難しいかもしれない．</p>
<p>そんなときどうすればいいだろうか．</p>
<p>雑誌や<a href="http://wear.jp/">WEAR</a>などでサイズ感や着こなしを確かめることができる．</p>
<p>しかし，それらでモデルとして写っている人は皆顔がいい．</p>
<p>我々が今知りたいのは雰囲気イケメンになれる服装である．</p>
<p>そこで，我々の持てる技術を駆使し，<a href="https://twitter.com/made_up_123">いなふ</a>君に合う服をサジェストしたい．</p>
<h2>服が似合うか(ファッションチェック)</h2>
<h3>OpenCV</h3>
<p>服を着たモデルの画像からモデルの顔の位置を認識し，そこにその服を着せたい人間の顔を合成する．</p>
<p>モデルの顔認識には<a href="http://opencv.jp/">OpenCV</a>を用いることで容易に行うことができる．</p>
<p>例えば以下の画像はかの有名なレナ画像であるが，<a href="http://opencv.jp/">OpenCV</a>を用いて顔の範囲を特定し，その範囲内を圧縮することで容易にモザイク画像を作成することができる．</p>
<p><img alt="レナ" src="./img/lena.jpeg">
<img alt="レナ(モザイク加工)" src="./img/mosaic_lena.jpg"></p>
<p>以下のPythonコードを用いて，雑合成を行う．</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">IMAGE_PATH</span> <span class="o">=</span> <span class="s1">&#39;/path/to/model_image&#39;</span>
<span class="n">FACE_PATH</span> <span class="o">=</span> <span class="s1">&#39;/path/to/face_image&#39;</span>

<span class="n">imageIn</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">IMAGE_PATH</span><span class="p">)</span>


<span class="n">cascade_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/OpenCV/haarcascades/haarcascade_frontalface_alt.xml&quot;</span>

<span class="n">cascade</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CascadeClassifier</span><span class="p">(</span><span class="n">cascade_path</span><span class="p">)</span>

<span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">imageIn</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="n">face</span> <span class="o">=</span> <span class="n">cascade</span><span class="o">.</span><span class="n">detectMultiScale</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">scaleFactor</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">minNeighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minSize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>



<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">face</span><span class="p">:</span>
        <span class="n">faceIn</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">FACE_PATH</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">faceIn</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>
        <span class="n">faceIn</span> <span class="o">=</span> <span class="n">faceIn</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># 画像によって顔をぴったり合わせるためには値を変える必要がある</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">imageIn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="n">imageIn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">faceIn</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">faceIn</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">imageIn</span><span class="p">[</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">faceIn</span><span class="p">[:,:]</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">imageIn</span><span class="p">[</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>

<span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;out.jpg&#39;</span><span class="p">,</span> <span class="n">imageIn</span><span class="p">)</span>
</pre></div>


<h3>使ってみる</h3>
<p>まず，雑透過顔画像を用意する．</p>
<p><img alt="face" src="./img/itousan.png"></p>
<p>次に，着せたい服を着ているモデルの画像を用意する．</p>
<p><img alt="fashion" src="./img/fashion.jpg"></p>
<p>合成する．</p>
<p><img alt="out" src="./img/out.jpg"></p>
<p>雑なのでこういうことがある．</p>
<p><img alt="out2" src="./img/out2.jpg"></p>
<h2>まとめ</h2>
<p>自分で合成したほうがはやくね？</p>
<p>店に行って試着しろ</p>
<h2>謝辞</h2>
<p>ピ先輩におかれましては，今回の記事作成に関して貴重な資料を提供していただきまして，誠に感謝しております．</p>
<p>以上．</p>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; lapis_zero09 &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>